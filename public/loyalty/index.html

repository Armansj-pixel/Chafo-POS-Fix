<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CHAFU MATCHA – Loyalty</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#f6f7f8; color:#111827; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
    .center { text-align:center; }
    .card { background:#fff; border:1px solid var(--border); border-radius: 14px; padding:16px; }
    .muted { color: var(--muted); font-size: 12px; }
    .logo { width: 72px; height: 72px; object-fit: contain; border-radius: 12px; }
    .big { font-size: 26px; font-weight: 800; margin: 8px 0 2px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .stat { border:1px solid var(--border); border-radius:12px; padding:12px; }
    .stat b { font-size: 20px; display:block; }
    .pill { display:inline-block; border:1px solid var(--border); padding:4px 10px; border-radius:999px; font-size:12px; }
    .warn { color:#b45309; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="center" style="margin-bottom:12px">
      <img src="/logo.png" class="logo" alt="logo" onerror="this.style.display='none'"/>
      <div class="big">CHAFU MATCHA Loyalty</div>
      <div class="muted">Mamamatcha @ MTHaryono</div>
    </div>

    <div class="card">
      <div id="status">Memuat konfigurasi…</div>

      <div id="content" style="display:none">
        <div class="center" style="margin-bottom:10px">
          <div class="pill">ID Pelanggan: <code id="uidTxt"></code></div>
        </div>
        <div class="center" style="margin-bottom:10px">
          <h3 id="custName" style="margin:0">Pelanggan</h3>
          <div class="muted" id="lastUpdate" style="margin-top:4px"></div>
        </div>
        <div class="grid2" style="margin-bottom:12px">
          <div class="stat center">
            <div class="muted">Poin</div><b id="points">0</b>
          </div>
          <div class="stat center">
            <div class="muted">Kunjungan</div><b id="visits">0</b>
          </div>
        </div>
        <div class="muted center">Tunjukkan halaman ini ke kasir saat transaksi.</div>
      </div>

      <div id="notfound" style="display:none">
        <p class="warn"><b>Data tidak ditemukan.</b></p>
        <p class="muted">Gunakan link dari struk atau daftarkan nomor HP di kasir.</p>
      </div>

      <div id="invalid" style="display:none">
        <p class="warn"><b>Link tidak valid.</b></p>
        <p class="muted">Format: <code>/loyalty/?uid=08xxxxxxxxxx</code></p>
      </div>
    </div>
  </div>

  <script>
    (async function(){
      const qs = new URLSearchParams(location.search);
      const rawUid = (qs.get("uid") || "").trim();
      const uid = rawUid.replace(/\D/g, "");
      const $ = (id) => document.getElementById(id);
      const show = (id, on=true) => ($(id).style.display = on ? "" : "none");

      if (!uid || uid.length < 6) {
        show("status", false); show("invalid", true); return;
      }
      $("uidTxt").textContent = uid;

      try {
        const cfg = await fetch("/firebase-config.json").then(r=>r.json());
        firebase.initializeApp(cfg);
      } catch (e) {
        $("status").textContent = "Gagal memuat konfigurasi Firebase."; return;
      }

      $("status").textContent = "Mengambil data pelanggan…";
      const db = firebase.firestore();
      db.collection("customers").doc(uid).onSnapshot((snap)=>{
        if(!snap.exists){ show("status",false); show("notfound",true); return; }
        const d = snap.data() || {};
        $("custName").textContent = d.name || "Pelanggan";
        $("points").textContent = Number(d.points||0);
        $("visits").textContent = Number(d.visits||0);
        $("lastUpdate").textContent = d.updatedAt
          ? new Date(d.updatedAt.seconds ? d.updatedAt.seconds*1000 : d.updatedAt).toLocaleString("id-ID",{hour12:false})
          : "";
        show("status",false); show("content",true); show("notfound",false); show("invalid",false);
      }, (err)=>{
        console.error(err); $("status").textContent = "Gagal memuat data pelanggan.";
      });
    })();
  </script>
</body>
</html>